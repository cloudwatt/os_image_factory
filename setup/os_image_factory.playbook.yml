---
#
##
### Written by the CAT (Cloudwatt Automation Team)
##
#
- hosts: all
  become: yes

  vars:
    os_image_factory:
      packer:
        version: "0.8.6"
        zip_url: "https://releases.hashicorp.com/packer/0.8.6/packer_0.8.6_linux_amd64.zip"
      jenkins:
        local_url: "http://127.0.0.1:8080"
        repository_deb: "deb http://pkg.jenkins-ci.org/debian binary/"
        repo_key_deb: "http://pkg.jenkins-ci.org/debian/jenkins-ci.org.key"
        repository_yum: "http://pkg.jenkins.io/redhat-stable"
        repo_key_yum: "http://pkg.jenkins.io/redhat-stable/jenkins.io.key"

  tasks:
    - name: toolkit packages present (apt-based OSE)
      apt: pkg="{{ item }}" state=present
      with_items:
        - aptitude
        - git
        - python-dev
        - python-setuptools
      when: ansible_distribution == 'Debian' or ansible_distribution == 'Ubuntu'

    - name: toolkit packages present (yum-based OSE)
      yum: pkg="{{ item }}" state=present
      with_items:
        - git
        - python-devel
        - python-setuptools
        - gcc
      when: ansible_distribution == 'CentOS' or ansible_distribution == 'RedHat'

    - name: apt package pip is absent (apt-based OSE)
      apt: pkg=python-pip state=absent purge=yes
      when: ansible_distribution == 'Debian' or ansible_distribution == 'Ubuntu'

    - name: apt package pip is absent (yum-based OSE)
      yum: pkg=python*-pip state=absent
      when: ansible_distribution == 'CentOS' or ansible_distribution == 'RedHat'

    - name: system upgrade (apt-based OSE)
      apt: update_cache=yes upgrade=full
      when: ansible_distribution == 'Debian' or ansible_distribution == 'Ubuntu'

    - name: jenkins key server is known (apt-based OSE)
      apt_key: url="{{ os_image_factory.jenkins.repo_key_deb }}" state=present
      when: ansible_distribution == 'Debian' or ansible_distribution == 'Ubuntu'

    - name: jenkins package server is known (apt-based OSE)
      apt_repository: repo="{{ os_image_factory.jenkins.repository_deb }}" state=present
      when: ansible_distribution == 'Debian' or ansible_distribution == 'Ubuntu'

    - name: jenkins package server is known (yum-based OSE)
      yum_repository:
        name: "jenkins"
        description: "Jenkins CI packages server"
        baseurl: "{{ os_image_factory.jenkins.repository_yum }}"
        gpgcheck: yes
        gpgkey: "{{ os_image_factory.jenkins.repo_key_yum }}"
        state: present
      when: ansible_distribution == 'CentOS' or ansible_distribution == "RedHat"

    - name: needed packages installed (apt-based OSE)
      apt: update_cache=yes pkg="{{ item }}" state=present
      with_items:
        - libguestfs-tools
        - libffi-dev
        - python-cffi
        - libssl-dev
        - jenkins
        - unzip
      when: ansible_distribution == 'Debian' or ansible_distribution == 'Ubuntu'

    - name: needed packages installed (yum-based OSE)
      yum: update_cache=yes pkg="{{ item }}" state=present
      with_items:
        - libguestfs-tools
        - libffi-devel
        - openssl-devel
        - java-1.8.0-openjdk
        - jenkins
        - unzip
      when: ansible_distribution == 'CentOS' or ansible_distribution == 'RedHat'

    # https://issues.jenkins-ci.org/browse/JENKINS-35197
    - name: fix jenkins configuration (yum-based OSE)
      lineinfile: dest=/etc/sysconfig/jenkins regexp='^(JENKINS_JAVA_OPTIONS=.*)"$' line='\1 -Dhudson.diyChunking=false"' backrefs=yes
      when: ansible_distribution == 'CentOS' or ansible_distribution == 'RedHat'

    - name: jenkins service is up
      service: name=jenkins state=restarted enabled=yes

    - name: jenkins is kvm member
      user: name=jenkins groups=kvm append=yes

    - name: common aliases
      copy:
        dest=/etc/profile.d/aliases.sh
        content="alias ll=\"ls -aul\""
        owner=root
        group=root
        mode=0644

    - name: default sh is bash
      file: src=/bin/bash dest=/bin/sh state=link

    - name: check packer is installed
      stat: path=/usr/local/bin/packer
      register: packer_bin_check

    - name: setting fact packer_installed
      set_fact:
        packer_installed="{{ packer_bin_check.stat.exists }}"

    - name: checking installed packer version
      when: packer_installed
      shell: "/usr/local/bin/packer --version"
      ignore_errors: true
      register: packer_version

    - name: setting fact need_to_install_packer
      set_fact:
        need_to_install_packer="{{ (not packer_installed) or (packer_version.stdout != os_image_factory.packer.version) }}"

    - name: packer download
      when: need_to_install_packer
      get_url:
        url="{{ os_image_factory.packer.zip_url }}"
        dest=/tmp/packer.zip
        force=no

    - name: setting packer's group (apt-based OSE)
      set_fact: packer_group="staff"
      when: ansible_distribution == 'Debian' or ansible_distribution == 'Ubuntu'

    - name: setting packer's group (yum-based OSE)
      set_fact: packer_group="root"
      when: ansible_distribution == 'CentOS' or ansible_distribution == 'RedHat'

    - name: packer destination directory is ready
      when: need_to_install_packer
      file:
        path=/usr/local/bin
        state=directory
        owner=root
        group={{ packer_group }}
        mode=0755

    - name: unzip packer
      when: need_to_install_packer
      unarchive:
        src=/tmp/packer.zip
        dest=/usr/local/bin
        copy=no
        owner=root
        group={{ packer_group }}
        mode=0755

    - name: pip is installed
      easy_install: name=pip

    - name: openstack CLI is installed
      pip: name="{{ item }}" state=latest
      with_items:
        - pyopenssl
        - ndg-httpsclient
        - pyasn1
        - pip
      register: result
      until: result|success
      retries: 3
      delay: 2

    - name: openstack CLI is installed
      pip: name="{{ item.name }}" version="{{ item.version }}"
      with_items:
        - { name: os-client-config, version: 1.7.5 }
        - { name: python-glanceclient, version: 1.1.0 }
        - { name: python-novaclient, version: 2.30.0 }
        - { name: python-keystoneclient, version: 1.7.1 }
        - { name: python-neutronclient, version: 3.1.0 }
        - { name: python-heatclient, version: 0.6.0 }
        - { name: python-openstackclient, version: 1.7.0 }
        - { name: python-cinderclient, version: 1.4.0 }
        - { name: python-swiftclient, version: 2.5.0 }
      register: result
      until: result|success
      retries: 3
      delay: 2

    - name: download jenkins CLI jar file
      get_url:
        url="{{ os_image_factory.jenkins.local_url }}/jnlpJars/jenkins-cli.jar"
        dest=/root/jenkins-cli.jar
        force=no
      register: cli_download
      until: cli_download|success
      retries: 10
      delay: 6

    - name: get jenkins plugin list
      shell: "java -jar /root/jenkins-cli.jar -s {{ os_image_factory.jenkins.local_url }} list-plugins | grep -e ')$' | awk '{ print $1 }' | tr \"\n\" \" \""
      register: jenkins_plugins

    - name: install jenkins git plugin and update all installed plugins
      when: jenkins_plugins.stdout
      shell: "java -jar /root/jenkins-cli.jar -s {{ os_image_factory.jenkins.local_url }} install-plugin {{ jenkins_plugins.stdout }} git-client git"

    - name: safe-restart jenkins to apply plugins updates
      shell: "java -jar /root/jenkins-cli.jar -s {{ os_image_factory.jenkins.local_url }} safe-restart"
